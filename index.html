<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>YM2151 Web Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .controls {
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            margin: 5px;
        }
        .info {
            margin-top: 20px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>YM2151 Sine Wave Test</h1>
    
    <div class="controls">
        <button onclick="playSine(1.0)">Play 1 sec</button>
        <button onclick="playSine(0.5)">Play 0.5 sec</button>
        <button onclick="playSine(2.0)">Play 2 sec</button>
    </div>
    
    <div class="info" id="info">
        Click a button to generate and play a sine wave
    </div>
    
    <script>
        let audioContext;
        const OPM_CLOCK = 3579545;
        const CLOCK_STEP = 64;
        const OPM_SAMPLE_RATE = OPM_CLOCK / CLOCK_STEP;  // 約55930 Hz
        
        // レジスタ設定 (A4サイン波)
        const registers = [
            { reg: 0x20, data: 0xC7 },  // RL=11, FB=0, CON=7
            { reg: 0x60, data: 0x00 },  // M1 TL=0 (Max)
            { reg: 0x68, data: 0x7F },  // M2 TL=min
            { reg: 0x70, data: 0x7F },  // C1 TL=min
            { reg: 0x78, data: 0x7F },  // C2 TL=min
            { reg: 0x40, data: 0x01 },  // DT1=0, MUL=1
            { reg: 0x80, data: 0x1F },  // KS=0, AR=31
            { reg: 0xA0, data: 0x00 },  // AMS-EN=0, D1R=0
            { reg: 0xC0, data: 0x00 },  // DT2=0, D2R=0
            { reg: 0xE0, data: 0x00 },  // D1L=0, RR=0
            { reg: 0x28, data: 0x48 },  // KC = A4
            { reg: 0x30, data: 0x00 },  // KF = 0
            { reg: 0x08, data: 0x78 }   // Key On
        ];
        
        var Module = {
            onRuntimeInitialized: function() {
                console.log("Emscripten ready!");
                document.getElementById('info').innerHTML = 
                    `OPM Sample Rate: ${OPM_SAMPLE_RATE.toFixed(0)} Hz<br>Ready to play`;
            }
        };
        
        function playSine(durationSec = 1.0) {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            console.log(`Generating ${durationSec} sec sine wave...`);
            
            // OPMのサンプルレートでサンプル数を計算
            const numSamples = Math.floor(OPM_SAMPLE_RATE * durationSec);
            
            // [reg, data, reg, data, ...] に変換
            const regDataPairs = new Uint8Array(registers.length * 2);
            registers.forEach((r, i) => {
                regDataPairs[i * 2] = r.reg;
                regDataPairs[i * 2 + 1] = r.data;
            });
            
            // Wasmメモリに転送
            const pairPtr = Module._malloc(regDataPairs.length);
            Module.HEAPU8.set(regDataPairs, pairPtr);
            
            // C側の関数を呼び出し
            const actualSamples = Module._generate_sound(pairPtr, registers.length, numSamples);
            console.log("Generated samples:", actualSamples);
            
            // メモリ解放
            Module._free(pairPtr);
            
            if (actualSamples === 0) {
                console.error("Failed to generate samples");
                document.getElementById('info').innerHTML = 
                    '<span style="color: red;">Failed to generate samples</span>';
                return;
            }
            
            // サンプルデータを取得
            const buffer = new Float32Array(actualSamples);
            for (let i = 0; i < actualSamples; i++) {
                buffer[i] = Module._get_sample(i);
            }
            
            console.log("First 10 samples:", Array.from(buffer.slice(0, 10)));
            
            // AudioBufferを作成（OPMのサンプルレートを使用）
            const audioBuffer = audioContext.createBuffer(1, actualSamples, OPM_SAMPLE_RATE);
            audioBuffer.getChannelData(0).set(buffer);
            
            // 再生
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);
            source.start();
            
            console.log("Playing...");
            
            // 周波数推定（ゼロクロス法）
            let zeroCrossings = 0;
            for (let i = 1; i < actualSamples; i++) {
                if (buffer[i-1] <= 0 && buffer[i] > 0) {
                    zeroCrossings++;
                }
            }
            const estimatedFreq = zeroCrossings / durationSec;
            console.log("Estimated frequency:", estimatedFreq.toFixed(2), "Hz");
            
            // 情報表示を更新
            document.getElementById('info').innerHTML = 
                `Playing ${durationSec} sec<br>` +
                `Samples: ${actualSamples}<br>` +
                `Sample Rate: ${OPM_SAMPLE_RATE.toFixed(0)} Hz<br>` +
                `Estimated Frequency: ${estimatedFreq.toFixed(2)} Hz (should be ~440 Hz for A4)`;
            
            // バッファ解放
            Module._free_buffer();
        }
    </script>
    
    <script src="sine_test.js"></script>
</body>
</html>
