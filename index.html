<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>YM2151 Web Test</title>
</head>
<body>
    <h1>YM2151 Sine Wave Test</h1>
    <button onclick="playSine()">Play Sine Wave</button>

    <script>
        let audioContext;

        // Emscriptenモジュール設定
        var Module = {
            onRuntimeInitialized: function() {
                console.log("Emscripten ready!");
                console.log("HEAPF32:", typeof Module.HEAPF32);
                console.log("HEAP32:", typeof Module.HEAP32);
            }
        };

        function playSine() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }

            console.log("Generating sine wave...");
            
            // C関数を呼び出してポインタ取得
            const bufferPtr = Module._generate_sine();
            console.log("Buffer pointer:", bufferPtr);
            
            // サンプル数を計算
            const sampleRate = 44100;
            const duration = 1;
            const numSamples = sampleRate * duration;
            
            // Emscriptenのヒープから直接Float32Arrayを作成
            // bufferPtrはバイト単位なので、float(4バイト)で割る必要がある
            const buffer = new Float32Array(Module.HEAP8.buffer, bufferPtr, numSamples);
            
            console.log("First 10 samples:", Array.from(buffer.slice(0, 10)));
            
            // AudioBufferを作成
            const audioBuffer = audioContext.createBuffer(1, numSamples, sampleRate);
            const channelData = audioBuffer.getChannelData(0);
            
            // データをコピー
            channelData.set(buffer);
            
            // 再生
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);
            source.start();
            
            console.log("Playing...");
            
            // メモリ解放
            Module._free_buffer(bufferPtr);
        }
    </script>
    
    <script src="sine_test.js"></script>
</body>
</html>
