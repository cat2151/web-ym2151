<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>YM2151 Web Editor (Stereo Fixed)</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .controls { margin: 20px 0; padding: 15px; background: #eef; border-radius: 5px; }
        select { padding: 10px; font-size: 16px; margin-right: 10px; min-width: 200px; }
        button { padding: 10px 30px; font-size: 16px; margin: 5px; cursor: pointer; font-weight: bold;}
        .duration-display { margin-left: 10px; font-size: 14px; color: #555; }
        textarea { 
            width: 100%; 
            height: 300px; 
            font-family: 'Consolas', 'Monaco', monospace; 
            font-size: 14px; 
            padding: 10px;
            box-sizing: border-box;
            margin-top: 10px;
            border: 1px solid #ccc;
        }
        .info { margin-top: 20px; padding: 10px; background: #f0f0f0; border-radius: 5px; }
        h1 { margin-bottom: 5px; }
        .editor-label { margin-top: 20px; font-weight: bold; display: block; }
    </style>
</head>
<body>
    <h1>YM2151 JSON Editor (Stereo Fixed)</h1>
    
    <div class="controls">
        <label for="presetSelect"><strong>Load Preset: </strong></label>
        <select id="presetSelect" onchange="loadToEditor()">
            <option value="" disabled selected>Loading presets...</option>
        </select>
        <br><br>
        
        <button onclick="playSine()">Play Stereo</button>
        <span id="durationInfo" class="duration-display"></span>
    </div>

    <label class="editor-label" for="jsonEditor">Edit Events JSON:</label>
    <textarea id="jsonEditor" spellcheck="false"></textarea>
    
    <div class="info" id="info">
        Initializing...
    </div>
    
    <!-- 外部スクリプト読み込み -->
    <script src="sine_test.js"></script> 
    
    <script>
        let audioContext;
        const OPM_CLOCK = 3579545;
        const CLOCK_STEP = 64;
        const OPM_SAMPLE_RATE = OPM_CLOCK / CLOCK_STEP; // 約55930Hz
        
        let loadedPresets = [];

        var Module = {
            onRuntimeInitialized: function() {
                console.log("Emscripten ready!");
                document.getElementById('info').innerHTML = 
                    `OPM Internal Rate: ${OPM_SAMPLE_RATE.toFixed(0)} Hz<br>` +
                    `Waiting for presets...`;
                loadPresets();
            }
        };

        async function loadPresets() {
            try {
                const response = await fetch('presets.json');
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                loadedPresets = await response.json();
                
                const select = document.getElementById('presetSelect');
                select.innerHTML = ''; 

                if (!Array.isArray(loadedPresets) || loadedPresets.length === 0) {
                    const option = document.createElement('option');
                    option.text = "No presets found";
                    select.add(option);
                    return;
                }

                loadedPresets.forEach((preset, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.text = preset.name || `Preset ${index + 1}`;
                    select.add(option);
                });
                
                if(loadedPresets.length > 0) {
                    select.value = 0;
                    loadToEditor();
                }

                document.getElementById('info').innerHTML += "<br>Presets loaded.";

            } catch (error) {
                console.error('Error loading presets:', error);
                document.getElementById('info').innerHTML = 
                    `<span style="color: red;">Error loading 'presets.json'.</span>`;
            }
        }

        function loadToEditor() {
            const select = document.getElementById('presetSelect');
            const selectedIndex = select.value;
            if (selectedIndex === "" || !loadedPresets[selectedIndex]) return;

            const editObj = {
                events: loadedPresets[selectedIndex].events
            };

            const textarea = document.getElementById('jsonEditor');
            textarea.value = JSON.stringify(editObj, null, 2);
            updateDurationDisplay(editObj.events);
        }
        
        function calculateDuration(events) {
            if (!events || events.length === 0) return 1.0;
            let maxTime = 0.0;
            events.forEach(evt => {
                const t = parseFloat(evt.time);
                if (!isNaN(t) && t > maxTime) maxTime = t;
            });
            return maxTime + 1.0;
        }

        function updateDurationDisplay(events) {
            const d = calculateDuration(events);
            document.getElementById('durationInfo').innerText = `(Calculated Duration: ${d.toFixed(2)} sec)`;
        }

        function playSine() {
            const textarea = document.getElementById('jsonEditor');
            let currentData = null;
            let currentEvents = [];

            try {
                currentData = JSON.parse(textarea.value);
                if (!currentData.events || !Array.isArray(currentData.events)) {
                    throw new Error("JSON must contain an 'events' array.");
                }
                currentEvents = currentData.events;
                if (currentEvents.length === 0) {
                    alert("Events array is empty.");
                    return;
                }
            } catch (e) {
                alert("Invalid JSON format:\n" + e.message);
                return;
            }

            const durationSec = calculateDuration(currentEvents);
            updateDurationDisplay(currentEvents);

            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            // OPM_SAMPLE_RATE ベースでの生成サンプル数（フレーム数）
            const numFramesRaw = Math.floor(OPM_SAMPLE_RATE * durationSec);
            
            const STRUCT_SIZE = 8;
            const bufferSize = currentEvents.length * STRUCT_SIZE;
            const dataPtr = Module._malloc(bufferSize);
            const view = new DataView(Module.HEAPU8.buffer);
            
            currentEvents.forEach((evt, i) => {
                const baseAddr = dataPtr + (i * STRUCT_SIZE);
                view.setFloat32(baseAddr, parseFloat(evt.time), true);
                Module.HEAPU8[baseAddr + 4] = parseInt(evt.addr);
                Module.HEAPU8[baseAddr + 5] = parseInt(evt.data);
            });
            
            console.log("generate...");
            // C側を実行: 戻り値は「生成されたフレーム数」
            const actualFrames = Module._generate_sound(dataPtr, currentEvents.length, numFramesRaw);
            Module._free(dataPtr);
            
            if (actualFrames <= 0) {
                console.error("Failed to generate samples");
                return;
            } else {
                console.log("generated");
            }
            
            const rawLeft = new Float32Array(actualFrames);
            const rawRight = new Float32Array(actualFrames);
            // C側のバッファは [L0, R0, L1, R1, ...] の順で並んでいる
            for (let i = 0; i < actualFrames; i++) {
                rawLeft[i] = Module._get_sample(i * 2);
                rawRight[i] = Module._get_sample(i * 2 + 1);
            }
            
            const audioBuffer = audioContext.createBuffer(2, rawLeft.length, OPM_SAMPLE_RATE);
            
            audioBuffer.getChannelData(0).set(rawLeft);
            audioBuffer.getChannelData(1).set(rawRight);
            
            const source = audioContext.createBufferSource();
            source.buffer = audioBuffer;
            source.connect(audioContext.destination);
            source.start();
            
            document.getElementById('info').innerHTML = 
                `Playing Stereo<br>` +
                `${actualFrames} frames (@${OPM_SAMPLE_RATE.toFixed(0)}Hz)<br>`;

            Module._free_buffer();
        }
    </script>
</body>
</html>
